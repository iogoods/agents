{"version":3,"sources":["../src/actions/webSearch.ts","../src/services/webSearchService.ts","../src/index.ts"],"sourcesContent":["import {\r\n    type Action,\r\n    type HandlerCallback,\r\n    type IAgentRuntime,\r\n    type Memory,\r\n    type State,\r\n    elizaLogger\r\n} from \"@elizaos/core\";\r\nimport { encodingForModel, type TiktokenModel } from \"js-tiktoken\";\r\nimport { WebSearchService } from \"../services/webSearchService\";\r\nimport type { SearchResult } from \"../types\";\r\n\r\nconst DEFAULT_MAX_WEB_SEARCH_TOKENS = 4000;\r\nconst DEFAULT_MODEL_ENCODING = \"gpt-3.5-turbo\";\r\n\r\nfunction getTotalTokensFromString(\r\n    str: string,\r\n    encodingName: TiktokenModel = DEFAULT_MODEL_ENCODING\r\n) {\r\n    const encoding = encodingForModel(encodingName);\r\n    return encoding.encode(str).length;\r\n}\r\n\r\nfunction MaxTokens(\r\n    data: string,\r\n    maxTokens: number = DEFAULT_MAX_WEB_SEARCH_TOKENS\r\n): string {\r\n    if (getTotalTokensFromString(data) >= maxTokens) {\r\n        return data.slice(0, maxTokens);\r\n    }\r\n    return data;\r\n}\r\n\r\nexport const webSearch: Action = {\r\n    name: \"WEB_SEARCH\",\r\n    similes: [\r\n        \"SEARCH_WEB\",\r\n        \"INTERNET_SEARCH\",\r\n        \"LOOKUP\",\r\n        \"QUERY_WEB\",\r\n        \"FIND_ONLINE\",\r\n        \"SEARCH_ENGINE\",\r\n        \"WEB_LOOKUP\",\r\n        \"ONLINE_SEARCH\",\r\n        \"FIND_INFORMATION\",\r\n    ],\r\n    suppressInitialMessage: true,\r\n    description:\r\n        \"Perform a web search to find information related to the message.\",\r\n    // eslint-disable-next-line\r\n    validate: async (runtime: IAgentRuntime, message: Memory) => {\r\n        const tavilyApiKeyOk = !!runtime.getSetting(\"TAVILY_API_KEY\");\r\n\r\n        return tavilyApiKeyOk;\r\n    },\r\n    handler: async (\r\n        runtime: IAgentRuntime,\r\n        message: Memory,\r\n        state: State,\r\n        options: any,\r\n        callback: HandlerCallback\r\n    ) => {\r\n        elizaLogger.log(\"Composing state for message:\", message);\r\n        state = (await runtime.composeState(message)) as State;\r\n        const userId = runtime.agentId;\r\n        elizaLogger.log(\"User ID:\", userId);\r\n\r\n        const webSearchPrompt = message.content.text;\r\n        elizaLogger.log(\"web search prompt received:\", webSearchPrompt);\r\n\r\n        const webSearchService = new WebSearchService();\r\n        await webSearchService.initialize(runtime);\r\n        const searchResponse = await webSearchService.search(\r\n            webSearchPrompt,\r\n        );\r\n\r\n        if (searchResponse && searchResponse.results.length) {\r\n            const responseList = searchResponse.answer\r\n                ? `${searchResponse.answer}${\r\n                      Array.isArray(searchResponse.results) &&\r\n                      searchResponse.results.length > 0\r\n                          ? `\\n\\nFor more details, you can check out these resources:\\n${searchResponse.results\r\n                                .map(\r\n                                    (result: SearchResult, index: number) =>\r\n                                        `${index + 1}. [${result.title}](${result.url})`\r\n                                )\r\n                                .join(\"\\n\")}`\r\n                          : \"\"\r\n                  }`\r\n                : \"\";\r\n\r\n            callback({\r\n                text: MaxTokens(responseList, DEFAULT_MAX_WEB_SEARCH_TOKENS),\r\n            });\r\n        } else {\r\n            elizaLogger.error(\"search failed or returned no data.\");\r\n        }\r\n    },\r\n    examples: [\r\n        [\r\n            {\r\n                user: \"{{user1}}\",\r\n                content: {\r\n                    text: \"Find the latest news about SpaceX launches.\",\r\n                },\r\n            },\r\n            {\r\n                user: \"{{agentName}}\",\r\n                content: {\r\n                    text: \"Here is the latest news about SpaceX launches:\",\r\n                    action: \"WEB_SEARCH\",\r\n                },\r\n            },\r\n        ],\r\n        [\r\n            {\r\n                user: \"{{user1}}\",\r\n                content: {\r\n                    text: \"Can you find details about the iPhone 16 release?\",\r\n                },\r\n            },\r\n            {\r\n                user: \"{{agentName}}\",\r\n                content: {\r\n                    text: \"Here are the details I found about the iPhone 16 release:\",\r\n                    action: \"WEB_SEARCH\",\r\n                },\r\n            },\r\n        ],\r\n        [\r\n            {\r\n                user: \"{{user1}}\",\r\n                content: {\r\n                    text: \"What is the schedule for the next FIFA World Cup?\",\r\n                },\r\n            },\r\n            {\r\n                user: \"{{agentName}}\",\r\n                content: {\r\n                    text: \"Here is the schedule for the next FIFA World Cup:\",\r\n                    action: \"WEB_SEARCH\",\r\n                },\r\n            },\r\n        ],\r\n        [\r\n            {\r\n                user: \"{{user1}}\",\r\n                content: { text: \"Check the latest stock price of Tesla.\" },\r\n            },\r\n            {\r\n                user: \"{{agentName}}\",\r\n                content: {\r\n                    text: \"Here is the latest stock price of Tesla I found:\",\r\n                    action: \"WEB_SEARCH\",\r\n                },\r\n            },\r\n        ],\r\n        [\r\n            {\r\n                user: \"{{user1}}\",\r\n                content: {\r\n                    text: \"What are the current trending movies in the US?\",\r\n                },\r\n            },\r\n            {\r\n                user: \"{{agentName}}\",\r\n                content: {\r\n                    text: \"Here are the current trending movies in the US:\",\r\n                    action: \"WEB_SEARCH\",\r\n                },\r\n            },\r\n        ],\r\n        [\r\n            {\r\n                user: \"{{user1}}\",\r\n                content: {\r\n                    text: \"What is the latest score in the NBA finals?\",\r\n                },\r\n            },\r\n            {\r\n                user: \"{{agentName}}\",\r\n                content: {\r\n                    text: \"Here is the latest score from the NBA finals:\",\r\n                    action: \"WEB_SEARCH\",\r\n                },\r\n            },\r\n        ],\r\n        [\r\n            {\r\n                user: \"{{user1}}\",\r\n                content: { text: \"When is the next Apple keynote event?\" },\r\n            },\r\n            {\r\n                user: \"{{agentName}}\",\r\n                content: {\r\n                    text: \"Here is the information about the next Apple keynote event:\",\r\n                    action: \"WEB_SEARCH\",\r\n                },\r\n            },\r\n        ],\r\n    ],\r\n} as Action;","import {\r\n    Service,\r\n    type IAgentRuntime,\r\n    ServiceType,\r\n} from \"@elizaos/core\";\r\nimport { tavily } from \"@tavily/core\";\r\nimport type { IWebSearchService, SearchOptions, SearchResponse } from \"../types\";\r\n\r\nexport type TavilyClient = ReturnType<typeof tavily>; // declaring manually because original package does not export its types\r\n\r\nexport class WebSearchService extends Service implements IWebSearchService {\r\n    public tavilyClient: TavilyClient\r\n\r\n    async initialize(_runtime: IAgentRuntime): Promise<void> {\r\n        const apiKey = _runtime.getSetting(\"TAVILY_API_KEY\") as string;\r\n        if (!apiKey) {\r\n            throw new Error(\"TAVILY_API_KEY is not set\");\r\n        }\r\n        this.tavilyClient = tavily({ apiKey });\r\n    }\r\n\r\n    getInstance(): IWebSearchService {\r\n        return WebSearchService.getInstance();\r\n    }\r\n\r\n    static get serviceType(): ServiceType {\r\n        return ServiceType.WEB_SEARCH;\r\n    }\r\n\r\n    async search(\r\n        query: string,\r\n        options?: SearchOptions,\r\n    ): Promise<SearchResponse> {\r\n        try {\r\n            const response = await this.tavilyClient.search(query, {\r\n                includeAnswer: options?.includeAnswer || true,\r\n                maxResults: options?.limit || 3,\r\n                topic: options?.type || \"general\",\r\n                searchDepth: options?.searchDepth || \"basic\",\r\n                includeImages: options?.includeImages || false,\r\n                days: options?.days || 3,\r\n            });\r\n\r\n            return response;\r\n        } catch (error) {\r\n            console.error(\"Web search error:\", error);\r\n            throw error;\r\n        }\r\n    }\r\n}\r\n","import { webSearch } from \"./actions/webSearch\";\r\nimport type { Plugin } from \"@elizaos/core\";\r\nimport { WebSearchService } from \"./services/webSearchService\";\r\n\r\nexport const webSearchPlugin: Plugin = {\r\n    name: \"webSearch\",\r\n    description: \"Search the web and get news\",\r\n    actions: [webSearch],\r\n    evaluators: [],\r\n    providers: [],\r\n    services: [new WebSearchService()],\r\n    clients: [],\r\n};\r\n\r\nexport default webSearchPlugin;\r\n"],"mappings":"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","names":[]}